---
output: word_document
---
```{r, echo = FALSE, message = FALSE}

library(XML) 
library(rvest)
library(plyr)
library(data.table)
library(ggplot2)
library(reshape2)
library(randomForest)
library(cvTools)

## objects that must be included in Global Environment to run every function without error 
## :gamelist, lineup, samename, player_id, trade_2015

## source function scripts 
source("crawl_part.R",encoding="UTF-8")
source("match_playerdata.R",encoding="UTF-8")
source("modeling.R",encoding="UTF-8")
load("work.RData")

```
---
title: "Big Contest 2015"
author: "Colin Rho"
date: "2015년 9월 5일"
output: html_document
---

# 1. 개요  

본 보고서는 '빅콘테스트 2015', 기계학습 기반 야구경기 예측에 대한 결과 보고서이다.  

# 2. 데이터 

1) 데이터 생성
본 분석에서는 경기 별 최신 정보를 수집하기 위해2015년 프로야구 개막일인 3/28부터 9/5까지의 일자별 정보를 사용하고자 한다.  경기마다 업데이트 되는 자료를 자동적으로 획득할 수 있도록 크롤링(crawling)을 사용하여 데이터셋을 생성하였다.
① 선수 개인 기록  데이터 : 선수마다 주어지는 고유의 url ID를 이용하여 선수의 일자별 경기 기록을 획득하였다.
②  경기 일정 및 선발 선수 데이터  : 경기 일정 별 선발 라인업을 웹 크로링을 통해 읽어온 후, 참여한 선수의 기록을 팀별로 합산하여 팀 데이터로 활용하였다.

2) 데이터 구조  
* 변수(Variables): 타자, 투수의 유의한 경기 지표를 변수로 설정하여 각각 득점과 실점을 예측에 활용하고자 한다. 이를 통해 각 팀 별 피타고리안 승률을 산출하여 승률 예측에  높은 정확도를 기대할 수 있다.


#### **타자의 경기기록을 이용한 득점 예측 변수**
| **종속변수**  | **독립변수**  |
| :--- | :--- |
|AVG1(당일 타율), AB(타수), H(안타), X2B(2루타), X3B(3루타), HR(홈런), RBI(타점), SB(도루), CS(도루실패) |y(득점)|
|BB(4구),HBP(사구), SO(삼진), GDP(병살타), SLG(장타율), OBP(출루율), SBPER(도루성공률)                |      | 

#### **투수의 경기기록을 이용한 실점 예측 변수**
| **종속변수**  | **독립변수**  |
| :--- | :--- |
|ERA1(당일 평균자책점),  TBF(타자수), HA(피안타), HRA(피홈런), BBA(4구), HBPA(사구), SOA(삼진), ER(자책점) |y(실점)|
|WHIP(이닝당 출루허용률), LOBPER(잔루처리율)               |      | 


* 자료 구조: 득점과 실점 예측을 위해 아래와 같은 데이터 구조를 설정하였다. 독립변수와 종속변수 모두 지표를 일정기간동안 합산하여 사용하였다. 독립변수의 축적기간(term1)은 종속변수와의 오차를 최소화하는 기간을 팀 별로 설정하였고, 종속변수 축적기간(term2)은 9/6~9/30인 25일에서  빠진 경기수를 감안하여 23일로 고정하였다.  

*ex) term1 =60일,  term2=23일*


# 3. 방법론

### 1) 피타고리안 승률
$$ 기대승률 = \frac{득점^2}{득점^2 + 실점^2} $$
  피타고리안 기대승률(Pythagorean Expectation)은 야구에서 팀의 누적된 득점과 실점을 이용하여 예측한 승률을 말한다. 이는 어떤 게임에서 이길 가능성은 그 팀의 실력(quality)에 비례할 것이며, 그 실력은 득점과 실점의 비(ratio)로서 측정될 수 있을 것이라는 가정에서 출발한다. 보통 피타고리안 지수(Pythagorean exponent)는 2로 설정하며, 본 분석에서는 각 팀에 맞는 피타고리안 지수를 찾아서 좀 더 예측력을 높인 기대승률을 구하고자 한다.
 
### 2) 랜덤포레스트 

  기계적 학습이론(machine learning)에서는 예측의 정확성을 향상시키기 위해서 앙상블 기법(ensemble method)을 주로 사용한다. 그 중 한 가지 방법인 랜덤 포레스트(Random Forest)는 주어진 데이터를 이용하여 다수의 표본을 만들고, 이를 이용하여 얻어진 다수의 의사결정나무(decision tree)를 결합하는 방법이다. 이 방법은 상대적으로 다른 기계적 학습이론에 비해 정확성이 높고, 다수의 의사결정나무를 활용하므로 안정적이라는 장점이 있다. 본 분석에서는 랜덤 포레스트를 이용한 회귀분석을 실시하여, 각 팀의 득점과 실점을 예측하고자 한다. 이렇게 예측한 득점과 실점은 누적하여 피타고리안 기대승률을 구하는데 사용하고자 한다.
  
# 4. 분석과정

### 1) 피타고리안 승률

  일반적으로 알려져 있는 피타고리안 지수(Pythagorean exponent)는 2 이지만, 각 팀 별로 잘 맞는 팀이 있고 그렇지 않은 팀이 있었다. 애초에 피타고리안 승률은 미국의 메이저리그에서 고안된 방법으로, 다른 리그에서는 그 값이 다소 정확하지 않을 수 있다. 또한 우리의 목적은 각 팀의 미래 누적 득점과 실점을 예상하여 승률을 예측하는데 있으므로, 각 팀별로 보다 그 팀의 특성을 잘 나타낼 수 있는 피타고리안 지수를 찾는 것이 바람직 하다. 보다 정확한 적합을 위해 지수의 값을 바꾸는 것은 물론 예측승률의 평행이동 또한 고려하였다. 
  
### 2) 랜덤포레스트

#### data setting
  
  데이터를 구성할 때 먼저 결정해야 할 것은 독립변수 축적 기간이다. 얼만큼의 기간을 두고 축적하는가에 따라 회귀모형의 오차가 달라지기 때문에, 가장 오차를 줄일 수 있는 모형을 세울 수 있도록 설정하는 것이 중요하다. 따라서 다양한 축적 기간 중에 회귀 모형의 평균 오차 제곱(MSE)이 최소화되는 기간을 선택하는 함수를 만들어, 각 팀에 맞는 기간을 결정한다. 또한 축적하는 시작 날짜를 각 팀의 독립변수 축적 기간에 맞게 구하여, 갖고 있는 데이터를 모두 활용할 수 있도록 한다.
  
#### modeling
  
  데이터를 완성하고 나면, 팀 별로 랜덤 포레스트를 이용한 회귀분석을 실시하여 모형을 세운다. 가장 최적화된 모형을 선택하였기 때문에, 이를 이용해 각 팀의 득점과 실점을 예측한다. 

# 5. 결과

각 팀별로 최적의 피타고리안 기대승률 공식을 도출하였다. (7월 부터 현재까지의 실제승률 기준)  

```{r, fig.width=12, fig.height=10 ,echo = FALSE}
multiplot( p_nex, p_doo, p_lot, p_sam, p_han, p_KIA, p_kt, p_LG, p_NC, p_SK, cols=3 )
```


